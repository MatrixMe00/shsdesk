function payWithPaystack(){if(!(parseFloat(cust_amount)<=0))return new Promise((e,a)=>{cust_amount=3060;const t=paymentForm.find("#pay_email").val();try{var n=PaystackPop.setup({key:api_key,email:t,amount:cust_amount,currency:"GHS",split_code:school_split_code,metadata:{custom_fields:[{display_name:"Mobile Number",variable_name:"mobile_number",value:$("#pay_phone").val()},{display_name:"Customer's Name",variable_name:"customer_name",value:$("#pay_fullname").val()},{display_name:"School Name",variable_name:"school_name",value:$("#school_admission_case #school_select option:selected").html()},{display_name:"Payment Type",variable_name:"payment_type",value:"admission"}]},callback:function(a){clearInterval(trackKeeper),payment_received=!0,sendSMS(a.reference),transaction_reference=a.reference,message="Transaction was made successfully",messageBoxTimeout("paymentForm",message,"success"),e(a.reference)},onClose:function(){alert_box("Transaction has been canceled by user","secondary",10),a(!1)}});n.openIframe()}catch(e){e=e.toString(),e.indexOf("PaystackPop is not defined")>-1?alert_box("You are currently offline. Please check your internet connection and try again later","danger",7):alert_box(e,"danger"),a(!1)}});alert_box("Could not find payment price")}function displayAdmissionForm(e){$("#ad_transaction_id").val(e),$("#ad_index").val($("#student_index_number").val()),$("#ad_index").blur(),$("#admission button[name=continue]").prop("disabled",!1).click()}async function trackTransactions(e=""){if(!reference_parsed){const a=$("#pay_fullname").val(),t=$("#pay_email").val(),n=$("#pay_phone").val();let s=$("#pay_amount").val().split(" ");s=s[1];const o=parseFloat(((.0195+Number.EPSILON)*parseInt(s)).toFixed(2)),r=parseInt(selectedSchool.val());if(r>0){const c={transaction_id:e,contact_number:n,school:r,amount:s,deduction:o,contact_email:t,contact_name:a,submit:"trackTransaction"};await $.ajax({url:paymentForm.attr("action"),type:"POST",dataType:"text",data:c,cache:!1,timeout:3e4,success:function(a){"success"==a?($("#ad_transaction_id").val(e),reference_parsed=!0,transaction_reference="",message="Reference ID confirmed",alert_box(message,"success",3.5)):"already-exist"==a?(reference_parsed=!0,transaction_reference=""):console.log(a)},error:function(e,a,t){message="Error occured while tracking your transaction",time=5,"timeout"==a?(message="Connection was timed out due to a slow network. Please try again later",time=8):e.responseText.indexOf("php")<0&&(message=t),console.log(e),$("#pay_fullname, #pay_email, #pay_phone").prop("disabled",!0),$("#pay_reference").prop("disabled",!1),messageBoxTimeout("paymentForm",message,"error",time)}})}}return reference_parsed}async function reCheck(){""!=transaction_reference&&(++retry_counter,reference_parsed=await trackTransactions(transaction_reference)),reference_parsed?(reference_parsed=!1,payment_received=!1,transaction_reference="",retry_counter=0,clearInterval(trackKeeper)):3!=retry_counter||reference_parsed?setTimeout(async function(){await reCheck()},3e3):alert_box("Slow network detected","warning",8)}async function sendSMS(e){const a=$("#pay_phone").val().replace("+",""),t="Your payment was successful. Your transaction reference is "+e+". You can use this if you experience a problem while filling your form and would want to try again";dataString={submit:"sendTransaction",phone:a,message:t};await $.ajax({url:"sms/sms.php",data:dataString,type:"POST",dataType:"json",timeout:3e4,success:function(a){const t=JSON.parse(JSON.stringify(a));if("success"==t.status)alert_box("SMS sent successfully","success");else{const a="An sms could not be sent, but payment was successful. Your transaction reference is "+e+". Save this value at a safe place";alert_box(a,"danger",10)}},error:function(a,t){alert_box("An error occured while sending sms, but payment was successful. Your transaction reference is "+e+". Save this value at a safe place","warning",15),"timeout"==t?alert_box("Connection was timed out due to a slow network. Please try again later","danger"):console.log(a.responseText)}})}async function passPaymentToDatabase(e){const a=$("#pay_fullname").val(),t=$("#pay_email").val(),n=$("#pay_phone").val();let s=$("#pay_amount").val().split(" ");s=s[1];const o=parseFloat(((.0195+Number.EPSILON)*parseInt(s)).toFixed(2)),r=selectedSchool.val();if(r>0){const c={transaction_id:e,contact_number:n,school:r,amount:s,deduction:o,contact_email:t,contact_name:a,submit:"add_payment_data"};await $.ajax({url:paymentForm.attr("action"),type:"POST",dataType:"text",data:c,cache:!1,timeout:3e4,success:function(e){e.includes("success")?(cont=e.split("-")[1],html="<p style='text-align: center; font-size: small; color: #666'>Having trouble? Contact the admin via <a href='tel:"+cont+"' style='color: blue'>"+cont+"</a></p>",$("#admission #form_footer").html(html),message="Transaction ID parsed",reference_parsed=!0,transaction_reference="",alert_box(message,"success",3)):"database_send_error"==e?(form_name="paymentForm",message="Admin contact could not be retrieved",alert_box(message,"warning"),console.log(e)):(form_name="paymentForm",message="An error prevented the admin contact to be retrieved",alert_box(message,"warning",10),console.log(e))},error:function(e,a,t){message="Error communicating with server. Validation failed on first try","timeout"==a?message="Connection was timed out due to a slow network. Please try again later":!e.responseText.indexOf("php")<0&&(message=t),$("#pay_fullname, #pay_email, #pay_phone").prop("disabled",!0),$("#pay_reference").prop("disabled",!1),alert_box(message,"warning")}})}}function getKey(){const e=selectedSchool.val();return new Promise((a,t)=>{$.ajax({url:"./submit.php",data:{submit:"get_keys_ajax",schoolID:e},success:function(e){a(e)},error:function(e){t(e)}})})}let reference_parsed=!1,payment_received=!1,transaction_reference="",retry_counter=0,api_key="",school_split_code="",cust_amount=0;const paymentForm=$("form[name=paymentForm]"),selectedSchool=$("#school_select");trackKeeper=null,$(document).ready(async function(){cust_amount=await ajaxCall({url:"submit.php",formData:{submit:"get_admission_price"},method:"POST",returnType:"json"}),cust_amount=parseFloat(cust_amount.price)||0}),paymentForm.submit(async function(){const e="paymentForm";if(""==$("section#trans #pay_reference").val())if($("#pay_reference").prop("disabled",!0),$("#pay_fullname, #pay_email, #pay_phone").prop("disabled",!1),""===$("#pay_fullname").val()||null===$("pay_fullname").val())messageBoxTimeout("paymentForm","Please provide your fullname","error");else if(""===$("#pay_email").val()||null===$("pay_email").val())messageBoxTimeout("paymentForm","Please provide your email","error");else if(""===$("#pay_phone").val()||null===$("pay_phone").val())messageBoxTimeout("paymentForm","Please provide your phone number","error");else try{const e=await payWithPaystack();e?(displayAdmissionForm(e),passPaymentToDatabase(e),trackKeeper=setInterval(reCheck,3500)):(console.log(e),alert_box("Message: "+e))}catch(e){console.log("Payment Error: ",e)}else{$("#pay_fullname, #pay_email, #pay_phone").prop("disabled",!0).val("");const a=selectedSchool.val(),t=$("section#trans #pay_reference").val(),n={reference_id:t,submit:"checkReference",school_id:a};$.ajax({url:paymentForm.attr("action"),data:n,type:"POST",dataType:"text",cache:!1,timeout:3e4,beforeSend:function(){message=loadDisplay({size:"small",animation:"anim-fade anim-swing"}),messageType="load",time=0,messageBoxTimeout(e,message,messageType,time)},success:function(a){a.includes("success")?($("form[name=admissionForm] #ad_transaction_id").val(t),cont=a.split("-")[1],html="<p style='text-align: center; font-size: small; color: #666'>Finding trouble? Contact the admin via <a href='tel:"+cont+"' style='color: blue'>"+cont+"</a></p>",$("#admission #form_footer").html(html),$("#ad_index").val($("#student_index_number").val()),$("#ad_index").blur(),$("button[name=continue]").prop("disabled",!1).click(),$("#admission").removeClass("no_disp"),messageType="success",message="Verification was successful",time=5):"ref_expired"==a?(message="Sorry! This reference id has expired. Please make a new payment to continue",messageType="error",time=5):"error"==a?(message="Reference ID entered is incorrect. Please enter a valid id to continue",messageType="error",time=5):(message=a,messageType="error",time=0),messageBoxTimeout(e,message,messageType,time)},error:function(a,t,n){message="Error communicating with server. Please check your internet connection and try again later","timeout"===t&&(message="Connection was timed out due to a slow network. Please try again later"),messageType="error",time=5,console.log(n),messageBoxTimeout(e,message,messageType,time)}})}}),$("#paymentFormButton").click(async function(){try{const e=await getKey();e.indexOf(" | ")>-1?(api_key=e.split(" | ")[1],school_split_code=e.split(" | ")[0],paymentForm.submit()):(api_key="",school_split_code="",alert_box(e))}catch(e){console.error("Error fetching payment key:",e)}});